<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø²ÙˆØ§Ø± - Mauri Services</title>
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: #f8f9fa;
            color: #333;
        }
        
        .admin-header {
            background: white;
            padding: 1rem 2rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .admin-nav {
            background: #2c5aa0;
            color: white;
            padding: 1rem 2rem;
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }
        
        .admin-nav a {
            color: white;
            text-decoration: none;
            padding: 0.5rem 1rem;
            border-radius: 5px;
            transition: background 0.3s;
        }
        
        .admin-nav a:hover, .admin-nav a.active {
            background: rgba(255,255,255,0.2);
        }
        
        .content {
            padding: 2rem;
        }
        
        .section {
            background: white;
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }
        
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid #f0f0f0;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }
        
        th, td {
            padding: 1rem;
            text-align: right;
            border-bottom: 1px solid #eee;
        }
        
        th {
            background: #f8f9fa;
            font-weight: bold;
            color: #2c5aa0;
        }
        
        tr:hover {
            background: #f8f9fa;
        }
        
        .btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
            margin: 0.25rem;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }
        
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        
        .btn-primary {
            background: #2c5aa0;
            color: white;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 3px 10px rgba(0,0,0,0.2);
        }
        
        .logout-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 5px;
            cursor: pointer;
        }
        
        .stats-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .stat-card {
            background: white;
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            text-align: center;
            border-left: 4px solid #2c5aa0;
            transition: transform 0.3s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
        }
        
        .stat-number {
            font-size: 2.5rem;
            font-weight: bold;
            color: #2c5aa0;
            display: block;
        }
        
        .stat-trend {
            font-size: 0.9rem;
            margin-top: 0.5rem;
        }
        
        .trend-up { color: #28a745; }
        .trend-down { color: #dc3545; }

        .filters {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }

        .filter-select {
            padding: 0.5rem;
            border: 2px solid #ddd;
            border-radius: 6px;
            background: white;
            min-width: 150px;
        }

        .chart-container {
            background: white;
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
            height: 300px;
        }

        .visitor-info {
            background: #f8f9fa;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            margin: 0.25rem 0;
            font-size: 0.9rem;
        }

        @media (max-width: 768px) {
            .admin-nav {
                flex-direction: column;
                gap: 0.5rem;
            }
            
            .admin-header {
                padding: 1rem;
                flex-direction: column;
                gap: 1rem;
            }
            
            .content {
                padding: 1rem;
            }
            
            .stats-cards {
                grid-template-columns: 1fr;
            }
            
            table {
                font-size: 0.8rem;
            }
            
            th, td {
                padding: 0.5rem;
            }
            
            .filters {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <header class="admin-header">
        <h1>ğŸš€ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø²ÙˆØ§Ø± - Mauri Services</h1>
        <div>
            <span id="adminName">Ù…Ø±Ø­Ø¨Ø§Ù‹ØŒ Ø§Ù„Ù…Ø¯ÙŠØ±</span>
            <button class="logout-btn" onclick="logout()">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
        </div>
    </header>
    
    <nav class="admin-nav">
        <a href="admin-dashboard.html">ğŸ“Š Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</a>
        <a href="admin-visitors.html" class="active">ğŸ‘¥ Ø§Ù„Ø²ÙˆØ§Ø±</a>
        <a href="admin-orders.html">ğŸ“¦ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</a>
        <a href="admin-messages.html">ğŸ’¬ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„</a>
        <a href="admin-agents.html">ğŸ‘¥ Ø§Ù„ÙˆÙƒÙ„Ø§Ø¡</a>
        <a href="admin-users.html">ğŸ‘¤ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</a>
        <a href="admin-settings.html">âš™ï¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</a>
    </nav>
    
    <div class="content">
        <!-- Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª -->
        <div class="stats-cards">
            <div class="stat-card">
                <span class="stat-number" id="totalVisitors">0</span>
                <p>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø²ÙˆØ§Ø±</p>
                <div class="stat-trend trend-up" id="totalTrend">+0% Ø¹Ù† Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ù…Ø§Ø¶ÙŠ</div>
            </div>
            <div class="stat-card">
                <span class="stat-number" id="todayVisitors">0</span>
                <p>Ø²ÙˆØ§Ø± Ø§Ù„ÙŠÙˆÙ…</p>
                <div class="stat-trend trend-up" id="todayTrend">+0% Ø¹Ù† Ø§Ù„Ø£Ù…Ø³</div>
            </div>
            <div class="stat-card">
                <span class="stat-number" id="uniqueVisitors">0</span>
                <p>Ø²ÙˆØ§Ø± ÙØ±ÙŠØ¯ÙˆÙ†</p>
                <div class="stat-trend trend-up" id="uniqueTrend">+0% Ø¹Ù† Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ù…Ø§Ø¶ÙŠ</div>
            </div>
            <div class="stat-card">
                <span class="stat-number" id="activeNow">0</span>
                <p>Ù†Ø´Ø·ÙˆÙ† Ø§Ù„Ø¢Ù†</p>
                <div class="stat-trend trend-up" id="activeTrend">ÙÙŠ Ø¢Ø®Ø± 5 Ø¯Ù‚Ø§Ø¦Ù‚</div>
            </div>
        </div>

        <!-- ØªØ­Ù„ÙŠÙ„Ø§Øª Ø§Ù„Ø²ÙˆØ§Ø± -->
        <div class="section">
            <div class="section-header">
                <h2>ğŸ“ˆ ØªØ­Ù„ÙŠÙ„Ø§Øª Ø§Ù„Ø²ÙˆØ§Ø±</h2>
                <div>
                    <button class="btn btn-primary" onclick="exportVisitors()">ğŸ“¥ ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
                    <button class="btn btn-danger" onclick="clearOldVisitors()">ğŸ—‘ï¸ Ù…Ø³Ø­ Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©</button>
                </div>
            </div>
            
            <div class="filters">
                <select class="filter-select" onchange="filterByPeriod(this.value)">
                    <option value="today">Ø§Ù„ÙŠÙˆÙ…</option>
                    <option value="week">Ø£Ø³Ø¨ÙˆØ¹</option>
                    <option value="month">Ø´Ù‡Ø±</option>
                    <option value="all">ÙƒÙ„ Ø§Ù„ÙˆÙ‚Øª</option>
                </select>
                <select class="filter-select" onchange="filterByPage(this.value)">
                    <option value="all">Ø¬Ù…ÙŠØ¹ Ø§Ù„ØµÙØ­Ø§Øª</option>
                    <option value="/">Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</option>
                    <option value="/services.html">Ø§Ù„Ø®Ø¯Ù…Ø§Øª</option>
                    <option value="/contact.html">Ø§ØªØµÙ„ Ø¨Ù†Ø§</option>
                </select>
            </div>
            
            <div id="visitorsTable">
                <!-- Ø³ÙŠØªÙ… Ù…Ù„Ø¤Ù‡Ø§ Ø¨Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØ© -->
            </div>
        </div>

        <!-- Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„ØµÙØ­Ø§Øª -->
        <div class="section">
            <div class="section-header">
                <h2>ğŸ“Š Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„ØµÙØ­Ø§Øª</h2>
            </div>
            <div id="pagesStats">
                <!-- Ø³ÙŠØªÙ… Ù…Ù„Ø¤Ù‡Ø§ Ø¨Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØ© -->
            </div>
        </div>
    </div>

    <script>
        // ØªÙ‡ÙŠØ¦Ø© Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyC3qL5dzdOvIv7raaEd3xWOOraCiRks0h0",
            authDomain: "mauri-services.firebaseapp.com",
            projectId: "mauri-services",
            storageBucket: "mauri-services.firebasestorage.app",
            messagingSenderId: "324986363643",
            appId: "1:324986363643:web:803453b8ff2681b51d1a5e"
        };
        
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
        auth.onAuthStateChanged((user) => {
            if (!user) {
                window.location.href = 'admin-login.html';
            } else {
                // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¯ÙˆØ± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
                db.collection('users').doc(user.uid).get().then((doc) => {
                    if (doc.exists && doc.data().role === 'admin') {
                        document.getElementById('adminName').textContent = `Ù…Ø±Ø­Ø¨Ø§Ù‹ØŒ ${doc.data().name}`;
                        initVisitorsPage();
                    } else {
                        alert('âŒ Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…');
                        logout();
                    }
                });
            }
        });
        
        function logout() {
            auth.signOut().then(() => {
                window.location.href = 'admin-login.html';
            });
        }
        
        // Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø²ÙˆØ§Ø± Ù…Ø¹ Firebase
        class VisitorsManager {
            constructor() {
                this.visitors = [];
                this.filteredVisitors = [];
                this.currentPeriod = 'today';
                this.currentPageFilter = 'all';
                this.init();
            }
            
            async init() {
                await this.loadVisitors();
                this.setupRealtimeListeners();
                this.setupAutoRefresh();
            }
            
            async loadVisitors() {
                try {
                    const visitorsSnapshot = await db.collection('visitors')
                        .orderBy('timestamp', 'desc')
                        .get();
                    
                    this.visitors = visitorsSnapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));
                    
                    this.updateStats();
                    this.renderVisitors();
                    this.renderPagesStats();
                    
                } catch (error) {
                    console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø²ÙˆØ§Ø±:', error);
                }
            }
            
            updateStats() {
                const totalVisitors = this.visitors.length;
                
                // Ø²ÙˆØ§Ø± Ø§Ù„ÙŠÙˆÙ…
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const todayVisitors = this.visitors.filter(v => 
                    v.timestamp.toDate() >= today
                ).length;
                
                // Ø²ÙˆØ§Ø± ÙØ±ÙŠØ¯ÙˆÙ† (Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ù€ IP)
                const uniqueIPs = [...new Set(this.visitors.map(v => v.ip))];
                const uniqueVisitors = uniqueIPs.length;
                
                // Ù†Ø´Ø·ÙˆÙ† Ø§Ù„Ø¢Ù† (Ø¢Ø®Ø± 5 Ø¯Ù‚Ø§Ø¦Ù‚)
                const fiveMinutesAgo = new Date(Date.now() - 5 * 60 * 1000);
                const activeNow = this.visitors.filter(v => 
                    v.timestamp.toDate() >= fiveMinutesAgo
                ).length;
                
                document.getElementById('totalVisitors').textContent = totalVisitors.toLocaleString();
                document.getElementById('todayVisitors').textContent = todayVisitors.toLocaleString();
                document.getElementById('uniqueVisitors').textContent = uniqueVisitors.toLocaleString();
                document.getElementById('activeNow').textContent = activeNow.toLocaleString();
            }
            
            renderVisitors() {
                const now = new Date();
                let startDate;
                
                switch(this.currentPeriod) {
                    case 'today':
                        startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                        break;
                    case 'week':
                        startDate = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                        break;
                    case 'month':
                        startDate = new Date(now.getFullYear(), now.getMonth() - 1, now.getDate());
                        break;
                    default:
                        startDate = new Date(0); // ÙƒÙ„ Ø§Ù„ÙˆÙ‚Øª
                }
                
                this.filteredVisitors = this.visitors.filter(visitor => {
                    const timeMatch = this.currentPeriod === 'all' || 
                        visitor.timestamp.toDate() >= startDate;
                    
                    const pageMatch = this.currentPageFilter === 'all' || 
                        visitor.page === this.currentPageFilter;
                    
                    return timeMatch && pageMatch;
                });
                
                const table = document.getElementById('visitorsTable');
                
                if (this.filteredVisitors.length === 0) {
                    table.innerHTML = '<div style="text-align: center; padding: 2rem; color: #666;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø²ÙŠØ§Ø±Ø§Øª Ù…Ø³Ø¬Ù„Ø©</div>';
                    return;
                }
                
                const html = `
                    <table>
                        <thead>
                            <tr>
                                <th>Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„ÙˆÙ‚Øª</th>
                                <th>Ø§Ù„ØµÙØ­Ø©</th>
                                <th>Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø²Ø§Ø¦Ø±</th>
                                <th>Ø§Ù„Ù…ØµØ¯Ø±</th>
                                <th>Ø§Ù„Ø¨Ù„Ø¯</th>
                                <th>Ù…Ø¯Ø© Ø§Ù„Ø²ÙŠØ§Ø±Ø©</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${this.filteredVisitors.slice(0, 100).map(visitor => `
                                <tr>
                                    <td>
                                        <strong>${visitor.timestamp.toDate().toLocaleDateString('ar-SA')}</strong>
                                        <br>
                                        <small>${visitor.timestamp.toDate().toLocaleTimeString('ar-SA')}</small>
                                    </td>
                                    <td>
                                        <div class="visitor-info">
                                            ${visitor.page || '/'}
                                        </div>
                                    </td>
                                    <td>
                                        <div class="visitor-info">
                                            <strong>IP:</strong> ${visitor.ip || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}
                                            <br>
                                            <strong>Ø§Ù„Ù…ØªØµÙØ­:</strong> ${this.getBrowserName(visitor.userAgent)}
                                            <br>
                                            <strong>Ø§Ù„Ù†Ø¸Ø§Ù…:</strong> ${this.getOSName(visitor.userAgent)}
                                        </div>
                                    </td>
                                    <td>
                                        <div class="visitor-info">
                                            ${visitor.referrer ? 
                                                `<a href="${visitor.referrer}" target="_blank">${this.getDomain(visitor.referrer)}</a>` : 
                                                'Ù…Ø¨Ø§Ø´Ø±'}
                                        </div>
                                    </td>
                                    <td>
                                        <div class="visitor-info">
                                            ${visitor.country || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}
                                            ${visitor.city ? ` - ${visitor.city}` : ''}
                                        </div>
                                    </td>
                                    <td>
                                        <div class="visitor-info">
                                            ${visitor.duration ? `${visitor.duration} Ø«Ø§Ù†ÙŠØ©` : 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}
                                        </div>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                    ${this.filteredVisitors.length > 100 ? 
                        `<div style="text-align: center; padding: 1rem; color: #666;">Ø¹Ø±Ø¶ 100 Ù…Ù† ${this.filteredVisitors.length} Ø²ÙŠØ§Ø±Ø©</div>` : ''}
                `;
                
                table.innerHTML = html;
            }
            
            renderPagesStats() {
                const pageStats = {};
                
                this.visitors.forEach(visitor => {
                    const page = visitor.page || '/';
                    if (!pageStats[page]) {
                        pageStats[page] = { visits: 0, unique: new Set() };
                    }
                    pageStats[page].visits++;
                    pageStats[page].unique.add(visitor.ip);
                });
                
                const pagesContainer = document.getElementById('pagesStats');
                const html = `
                    <table>
                        <thead>
                            <tr>
                                <th>Ø§Ù„ØµÙØ­Ø©</th>
                                <th>Ø¹Ø¯Ø¯ Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª</th>
                                <th>Ø²ÙˆØ§Ø± ÙØ±ÙŠØ¯ÙˆÙ†</th>
                                <th>Ø§Ù„Ù†Ø³Ø¨Ø©</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${Object.entries(pageStats).map(([page, stats]) => `
                                <tr>
                                    <td><strong>${page}</strong></td>
                                    <td>${stats.visits}</td>
                                    <td>${stats.unique.size}</td>
                                    <td>${((stats.visits / this.visitors.length) * 100).toFixed(1)}%</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
                
                pagesContainer.innerHTML = html;
            }
            
            getBrowserName(userAgent) {
                if (!userAgent) return 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';
                
                if (userAgent.includes('Chrome')) return 'Chrome';
                if (userAgent.includes('Firefox')) return 'Firefox';
                if (userAgent.includes('Safari')) return 'Safari';
                if (userAgent.includes('Edge')) return 'Edge';
                
                return 'Ù…ØªØµÙØ­ Ø¢Ø®Ø±';
            }
            
            getOSName(userAgent) {
                if (!userAgent) return 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';
                
                if (userAgent.includes('Windows')) return 'Windows';
                if (userAgent.includes('Mac')) return 'Mac';
                if (userAgent.includes('Linux')) return 'Linux';
                if (userAgent.includes('Android')) return 'Android';
                if (userAgent.includes('iOS')) return 'iOS';
                
                return 'Ù†Ø¸Ø§Ù… Ø¢Ø®Ø±';
            }
            
            getDomain(url) {
                try {
                    return new URL(url).hostname;
                } catch {
                    return url;
                }
            }
            
            setupRealtimeListeners() {
                // ØªØ­Ø¯ÙŠØ« ÙÙˆØ±ÙŠ Ø¹Ù†Ø¯ Ø¥Ø¶Ø§ÙØ© Ø²ÙˆØ§Ø± Ø¬Ø¯Ø¯
                db.collection('visitors')
                    .orderBy('timestamp', 'desc')
                    .limit(100)
                    .onSnapshot(() => {
                        this.loadVisitors();
                    });
            }
            
            setupAutoRefresh() {
                // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª ÙƒÙ„ Ø¯Ù‚ÙŠÙ‚Ø©
                setInterval(() => {
                    this.updateStats();
                }, 60000);
            }
        }
        
        // ÙˆØ¸Ø§Ø¦Ù Ø¹Ø§Ù…Ø©
        function filterByPeriod(period) {
            visitorsManager.currentPeriod = period;
            visitorsManager.renderVisitors();
        }
        
        function filterByPage(page) {
            visitorsManager.currentPageFilter = page;
            visitorsManager.renderVisitors();
        }
        
        async function clearOldVisitors() {
            if (confirm('âš ï¸ Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ù…Ø³Ø­ Ø²ÙˆØ§Ø± Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ù…Ø§Ø¶ÙŠØŸ Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù†Ù‡.')) {
                try {
                    const monthAgo = new Date();
                    monthAgo.setMonth(monthAgo.getMonth() - 1);
                    
                    const oldVisitors = await db.collection('visitors')
                        .where('timestamp', '<', monthAgo)
                        .get();
                    
                    const batch = db.batch();
                    oldVisitors.docs.forEach(doc => {
                        batch.delete(doc.ref);
                    });
                    
                    await batch.commit();
                    alert(`âœ… ØªÙ… Ù…Ø³Ø­ ${oldVisitors.size} Ø²ÙŠØ§Ø±Ø© Ù‚Ø¯ÙŠÙ…Ø©`);
                    
                } catch (error) {
                    console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ù…Ø³Ø­ Ø§Ù„Ø²ÙˆØ§Ø± Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©:', error);
                    alert('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ù…Ø³Ø­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
                }
            }
        }
        
        function exportVisitors() {
            const data = visitorsManager.filteredVisitors.map(visitor => ({
                'Ø§Ù„ØªØ§Ø±ÙŠØ®': visitor.timestamp.toDate().toLocaleDateString('ar-SA'),
                'Ø§Ù„ÙˆÙ‚Øª': visitor.timestamp.toDate().toLocaleTimeString('ar-SA'),
                'Ø§Ù„ØµÙØ­Ø©': visitor.page,
                'IP': visitor.ip,
                'Ø§Ù„Ù…ØªØµÙØ­': visitorsManager.getBrowserName(visitor.userAgent),
                'Ø§Ù„Ù†Ø¸Ø§Ù…': visitorsManager.getOSName(visitor.userAgent),
                'Ø§Ù„Ù…ØµØ¯Ø±': visitor.referrer || 'Ù…Ø¨Ø§Ø´Ø±',
                'Ø§Ù„Ø¨Ù„Ø¯': visitor.country || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ',
                'Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©': visitor.city || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ',
                'Ù…Ø¯Ø© Ø§Ù„Ø²ÙŠØ§Ø±Ø©': visitor.duration ? `${visitor.duration} Ø«Ø§Ù†ÙŠØ©` : 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'
            }));
            
            const csv = convertToCSV(data);
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            link.setAttribute('href', url);
            link.setAttribute('download', `Ø²ÙˆØ§Ø±_mauri-services_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        function convertToCSV(objArray) {
            const array = typeof objArray !== 'object' ? JSON.parse(objArray) : objArray;
            let str = '\uFEFF' + Object.keys(array[0]).join(',') + '\r\n';
            
            for (let i = 0; i < array.length; i++) {
                let line = '';
                for (let index in array[i]) {
                    if (line !== '') line += ',';
                    line += `"${array[i][index]}"`;
                }
                str += line + '\r\n';
            }
            return str;
        }
        
        // Ø¨Ø¯Ø¡ Ø§Ù„Ù†Ø¸Ø§Ù…
        let visitorsManager;
        function initVisitorsPage() {
            visitorsManager = new VisitorsManager();
        }
    </script>
</body>
</html>